# WhatsApp Stateful Application

Простое stateful-приложение на Node.js для работы с WhatsApp через библиотеку `@whiskeysockets/baileys`.

## Возможности

- ✅ Авторизация через QR-код
- ✅ Сохранение сессии между перезапусками (не нужно сканировать QR каждый раз)
- ✅ Отправка текстовых сообщений по номеру телефона
- ✅ Проверка регистрации номера в WhatsApp
- ✅ Обработка ошибок (номер не зарегистрирован)
- ✅ Интерактивный CLI интерфейс

## Требования

- Node.js версии 18.0.0 или выше
- npm или yarn

## Установка

1. Установите зависимости:
```bash
npm install
```

## Использование

⚠️ **ВАЖНО: Перед запуском убедитесь, что десктопная версия WhatsApp полностью закрыта!**

Один номер телефона не может быть подключен одновременно к нескольким клиентам WhatsApp. Если у вас открыта десктопная версия WhatsApp, закройте её полностью перед запуском этого приложения.

1. Запустите приложение:
```bash
npm start
```

2. При первом запуске отсканируйте QR-код, который появится в терминале, используя приложение WhatsApp на вашем телефоне:
   - Откройте WhatsApp на телефоне
   - Перейдите в Настройки → Связанные устройства
   - Нажмите "Связать устройство"
   - Отсканируйте QR-код из терминала

3. После успешного подключения вы сможете отправлять сообщения через интерактивный интерфейс:
   - Введите номер телефона в международном формате (например: +79991234567)
   - Введите текст сообщения
   - Сообщение будет отправлено

4. При последующих запусках приложения сессия будет автоматически восстановлена, и QR-код не потребуется.

## Программное использование

Вы также можете использовать функции программно в Node.js REPL или в своем коде:

```javascript
// После подключения к WhatsApp
global.sendWhatsAppMessage('+79991234567', 'Привет! Это тестовое сообщение');
```

## Структура проекта

```
whatsApp/
├── index.js              # Основной файл приложения
├── package.json          # Зависимости проекта
├── README.md             # Документация
├── .gitignore           # Игнорируемые файлы
└── auth_info_baileys/   # Папка с данными сессии (создается автоматически)
```

## Обработка ошибок

Приложение обрабатывает следующие случаи:
- Номер телефона не зарегистрирован в WhatsApp
- Неверный формат номера телефона
- Ошибки подключения и переподключения

## Устранение проблем

### Проблема: QR-код не появляется / Таймаут подключения

**Если QR-код не появляется в терминале**, это означает, что соединение не может установиться. **В первую очередь проверьте следующее:**

1. **⚠️ ЗАКРОЙТЕ десктопную версию WhatsApp** - это самая частая причина проблем!
   - Полностью закройте десктопное приложение WhatsApp (не просто сверните, а выйдите из него)
   - Проверьте диспетчер задач Windows, чтобы убедиться, что процесс WhatsApp не запущен
   - Один номер не может быть подключен к нескольким клиентам одновременно

2. **Проверьте интернет-соединение** - убедитесь, что у вас стабильное подключение к интернету

3. **Проверьте файрвол** - убедитесь, что файрвол Windows не блокирует исходящие соединения

4. **Отключите VPN** - если вы используете VPN, попробуйте отключить его временно

5. **Проверьте антивирус** - некоторые антивирусы могут блокировать WebSocket соединения

6. **Проверьте DNS** - попробуйте использовать публичные DNS (например, 8.8.8.8 от Google)

7. **Проверьте прокси** - если вы используете корпоративную сеть с прокси, может потребоваться настройка

8. **Очистите старую сессию** - если проблема сохраняется, попробуйте удалить сохраненную сессию:
   ```bash
   npm run clear
   ```
   Или вручную удалите папку `auth_info_baileys` и перезапустите приложение.

Приложение автоматически пытается переподключиться при ошибках подключения.

**Важно:** QR-код появляется только после успешного установления WebSocket соединения. Если соединение не устанавливается (таймаут), QR-код не будет сгенерирован.

## Важные замечания

- ⚠️ **Конфликт с десктопной версией WhatsApp**: Не запускайте это приложение одновременно с десктопной версией WhatsApp. Один номер телефона не может быть подключен к нескольким клиентам одновременно.
- Папка `auth_info_baileys` содержит данные вашей сессии. Не делитесь этими файлами с другими!
- Если вы вышли из WhatsApp на телефоне, удалите папку `auth_info_baileys` и перезапустите приложение для повторной авторизации.
- Соблюдайте условия использования WhatsApp и не нарушайте их политику.

## Технические детали

- Использует `useMultiFileAuthState` для сохранения сессии в файловой системе
- Автоматическое переподключение при разрыве соединения
- Проверка регистрации номера через `onWhatsApp` перед отправкой сообщения

